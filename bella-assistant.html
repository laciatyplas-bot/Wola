<script>
'use strict';

// === BELLA v3.1 ‚Äî ZINTEGROWANA Z ETERNIVERSE ===
class BellaV3 {
  constructor() {
    this.currentProfile = 'amazon';
    this.recognition = null;
    this.isRecording = false;
    this.activeBramaId = null;

    this.init();
    this.startAutoSave();
  }

  init() {
    this.bindElements();
    this.initSpeechRecognition();
    this.loadDraft();
    this.updateStats();
    this.bindEterniverse();
  }

  // =========================
  // BIND UI
  // =========================
  bindElements() {
    this.el = {
      console: document.getElementById('console'),
      editor: document.getElementById('editor'),
      suggestions: document.getElementById('suggestions'),
      profileBtns: document.querySelectorAll('.profile-btn'),
      startRec: document.getElementById('startRec'),
      stopRec: document.getElementById('stopRec'),
      aiAnalyze: document.getElementById('aiAnalyze'),
      aiGenerate: document.getElementById('aiGenerate'),
      exportDocx: document.getElementById('exportDocx'),
      exportPdf: document.getElementById('exportPdf'),
      wordCount: document.getElementById('wordCount'),
      readability: document.getElementById('readability'),
      sentiment: document.getElementById('sentiment')
    };

    this.el.profileBtns.forEach(btn =>
      btn.onclick = () => this.setProfile(btn.dataset.profile)
    );

    this.el.startRec.onclick = () => this.startRecording();
    this.el.stopRec.onclick = () => this.stopRecording();
    this.el.aiAnalyze.onclick = () => this.analyze();
    this.el.aiGenerate.onclick = () => this.generate();
    this.el.exportDocx.onclick = () => this.exportDocx();
    this.el.exportPdf.onclick = () => this.exportPdf();

    this.el.console.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.processCommand(this.el.console.value.trim());
        this.el.console.value = '';
      }
    });

    this.el.console.oninput =
    this.el.editor.oninput = () => this.updateStats();
  }

  // =========================
  // ETERNIVERSE INTEGRATION
  // =========================
  bindEterniverse() {
    document.addEventListener('worldSelected', e => {
      const world = e.detail.world;
      if (!world?.name) return;

      const match = world.name.match(/BRAMA\s+([IVX]+)/i);
      if (!match) return;

      this.activeBramaId = this.romanToNumber(match[1]);

      // AutoProfile (sp√≥jne z poprzednim modu≈Çem)
      const profileMap = {
        1:'wattpad',2:'eterseeker',3:'eterseeker',4:'eterseeker',
        5:'amazon',6:'eterseeker',7:'eterseeker',
        8:'wattpad',9:'wattpad',10:'eterseeker'
      };
      this.setProfile(profileMap[this.activeBramaId] || 'eterseeker');

      // Pamiƒôƒá Bramy ‚Üí console
      const mem = localStorage.getItem(
        'ETERNIVERSE_AI_MEMORY_BRAMA_' + this.activeBramaId
      );
      if (mem) {
        this.el.console.value =
          'PAMIƒòƒÜ BRAMY (kontekst):\n' + mem.slice(-2000);
      }
    });
  }

  // =========================
  // CORE
  // =========================
  setProfile(profile) {
    this.currentProfile = profile;
    this.el.profileBtns.forEach(b =>
      b.classList.toggle('active', b.dataset.profile === profile)
    );
  }

  processCommand(cmd) {
    if (!cmd) return;
    this.el.editor.value += '\n' + cmd;
    this.saveToBramaMemory(cmd);
    this.updateStats();
  }

  analyze() {
    this.renderSuggestions(this.getSuggestions(this.el.editor.value));
  }

  generate() {
    const base = {
      amazon: 'To nie jest zwyk≈Çy produkt. To decyzja.',
      wattpad: 'Zatrzyma≈Ça siƒô. Serce zadr≈ºa≈Ço.',
      eterseeker: 'Nie jeste≈õ my≈õlƒÖ. Jeste≈õ polem.'
    };
    this.el.editor.value += '\n\n' + base[this.currentProfile];
    this.saveToBramaMemory(base[this.currentProfile]);
    this.updateStats();
  }

  // =========================
  // MEMORY
  // =========================
  saveToBramaMemory(text) {
    if (!this.activeBramaId || !text) return;
    const key = 'ETERNIVERSE_AI_MEMORY_BRAMA_' + this.activeBramaId;
    const old = localStorage.getItem(key) || '';
    localStorage.setItem(key, old + '\n' + text.slice(-1200));
  }

  // =========================
  // EXPORT
  // =========================
  async exportDocx() {
    const { Document, Packer, Paragraph } = docx;
    const doc = new Document({
      sections: [{ children: [
        new Paragraph({ text: 'Bella Export', heading: 'Heading1' }),
        new Paragraph(this.el.editor.value)
      ]}]
    });
    const blob = await Packer.toBlob(doc);
    this.download(blob, 'bella.docx');
  }

  exportPdf() {
    const w = window.open('', '_blank');
    w.document.write(`<pre>${this.el.editor.value}</pre>`);
    w.print();
    w.close();
  }

  download(blob, name) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // =========================
  // UTILS
  // =========================
  romanToNumber(r) {
    return {I:1,II:2,III:3,IV:4,V:5,VI:6,VII:7,VIII:8,IX:9,X:10}[r];
  }

  updateStats() {
    const t = this.el.editor.value;
    const w = t.trim().split(/\s+/).filter(Boolean).length;
    this.el.wordCount.textContent = w;
    this.el.readability.textContent = Math.min(100, 60 + w/10);
    this.el.sentiment.textContent =
      /(mi≈Ço≈õƒá|wolno≈õƒá)/i.test(t) ? 'üòä' :
      /(b√≥l|strach)/i.test(t) ? 'üòî' : 'üòê';
  }

  startAutoSave() {
    setInterval(() => {
      localStorage.setItem('bella_draft', JSON.stringify({
        content: this.el.editor.value,
        profile: this.currentProfile,
        saved: new Date().toISOString()
      }));
    }, 5000);
  }

  initSpeechRecognition() {}
}

// START
new BellaV3();
</script>